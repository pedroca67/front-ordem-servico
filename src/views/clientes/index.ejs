<%- include("../partials/header") %>
<%- include('../partials/messages') %>

<div class="level mt-5">
    <div class="level-left">
        <h1 class="title">Clientes Cadastrados</h1>
    </div>
    
    <div class="level-right">
        <div class="field is-grouped">
            <div class="field has-addons mr-3">
                <p class="control">
                    <span class="button is-static">
                        <i class="fas fa-search"></i>
                    </span>
                </p>
                <p class="control">
                    <input class="input" type="text" id="buscaCliente" 
                           onkeyup="filtrarClientes()" 
                           placeholder="Nome ou CPF...">
                </p>
            </div>

            <p class="control">
                <a href="/clientes/novo" class="button is-primary">
                    <span class="icon"><i class="fas fa-user-plus"></i></span>
                    <span>Novo Cliente</span>
                </a>
            </p>
        </div>
    </div>
</div>

<div class="box">
    <table class="table is-fullwidth is-striped is-hoverable" id="tabela-clientes">
        <thead>
            <tr>
                <th>Nome</th>
                <th>CPF</th>
                <th>Email</th>
                <th>Telefone</th>
                <th class="has-text-centered">Ações</th>
            </tr>
        </thead>
        <tbody>
            <% clientes.forEach(c => { %>
                <tr>
                    <td class="has-text-weight-bold"><%= c.nome %></td>
                    <td class="cpf-celula"><%= c.cpf %></td>
                    <td><%= c.email %></td>
                    <td><%= c.telefone %></td>
                    <td class="has-text-centered">
                        <a href="/clientes/<%= c.id %>/editar" class="button is-small is-info is-light">Editar</a>
                        <a href="#" class="button is-small is-danger is-light" 
                           onclick="abrirModal('<%= c.id %>')">Excluir</a>
                    </td>
                </tr>
            <% }) %>
        </tbody>
    </table>
</div>

<!-- Modal de confirmação -->
<div id="modal-excluir" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Confirmar Exclusão</p>
      <button class="delete" aria-label="close" onclick="fecharModal()"></button>
    </header>
    <section class="modal-card-body">
      Tem certeza que deseja excluir este cliente?
    </section>
    <footer class="modal-card-foot">
      <button class="button is-danger" id="confirmarExcluir">Sim, excluir</button>
      <button class="button" onclick="fecharModal()">Cancelar</button>
    </footer>
  </div>
</div>

<script>
function filtrarClientes() {
    const input = document.getElementById("buscaCliente");
    const filter = input.value.toUpperCase().replace(/[.\-/]/g, ""); // Limpa pontos e traços da busca
    const table = document.getElementById("tabela-clientes");
    const tr = table.getElementsByTagName("tr");

    for (let i = 1; i < tr.length; i++) {
        const tdNome = tr[i].getElementsByTagName("td")[0];
        const tdCPF = tr[i].getElementsByTagName("td")[1];

        if (tdNome && tdCPF) {
            const txtNome = (tdNome.textContent || tdNome.innerText).toUpperCase();
            const txtCPF = (tdCPF.textContent || tdCPF.innerText).replace(/[.\-/]/g, "");

            // Se bater no nome OU no CPF limpo
            if (txtNome.indexOf(filter) > -1 || txtCPF.indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }
}

// ---------------------- Modal ----------------------
let clienteParaExcluir = null;

function abrirModal(clienteId) {
    clienteParaExcluir = clienteId;
    document.getElementById("modal-excluir").classList.add("is-active");
}

function fecharModal() {
    document.getElementById("modal-excluir").classList.remove("is-active");
    clienteParaExcluir = null;
}

document.getElementById("confirmarExcluir").addEventListener("click", function() {
    if (clienteParaExcluir) {
        window.location.href = `/clientes/${clienteParaExcluir}/excluir`;
    }
});
</script>

<%- include("../partials/footer") %>
